<!DOCTYPE html>
<html>
	<head>
		<title>Todo List</title>
		<meta name="theme-color" content="#4CAF50">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1">
		<script src="todo.js"></script>
		<style>
body, #addtext {
	font-family: monospace;
	font-size: 16px;
	margin: 0; padding: 0;
	background: #FAFAFA;
}
#add {
	display: flex;
	padding: 8px 0;
}
#addtext {
	flex-grow: 1;
	border:0;
	outline: 0;
	margin-right: 8px;
}
#addtext:focus {
	border-bottom: 2px solid #AAA;
}

#tasks {
	margin-top: 8px;
}
.task {
	padding: 8px 0;
}
.task input {
	padding: 0;
	margin: 0;
	border: 0;
	font: inherit;
	background: transparent;
	width: -webkit-fill-available;
	width: -moz-available;
	width: fill-available;
}
.task input:focus {	
	border-bottom: 2px solid #aaa;
	margin-bottom: -2px;
}
.task button {
	float: right;
}
.task-project, .task-context, .task-metadata, .task-due, .task-priority {
	text-decoration: none;
	color: inherit;
}
.task-project { color: #2196f3; }
.task-context { color: #4caf50; }
.task-due { color: #4caf50; }

.task-priority {
	color: #ffc107; }
	.task-priority-A {
		color: #f44336; }
	.task-priority-B {
		color: #ff9800; }
	.task-priority-C {
		color: #ff9800; }

.circle {
	border-radius: 16px;
	border: 0;
	background: #aaa;
	color: #fff;
	cursor: pointer;
	width: 16px;
	height: 16px;
	text-align: center;
	padding: 0;
	font-size: 14px;
}

main {
	margin: 0 80px;
}
#toolbar {
	padding: 16px 80px;
	background: #4CAF50;
	color: #FFF;
}
#toolbar a {
	text-decoration: none;
	color: #FFF;
}
@media (max-width: 600px) {
	main {
		margin: 0 16px;		
	}
	#toolbar {
		padding: 16px;
	}
}

		</style>
	</head>
	<body>
		<div id="toolbar">
			<a href="?">Todo</a>
			<a class="circle" style="float:right" download="todo.txt" id="download">&#x2B73;</a>
		</div>
		<main>
			<p id="filter" style="display:none"></p>
			<div id="tasks">
				
			</div>
			<div id="add">
				<input type="text" id="addtext" placeholder="New task..." />
				<button id="addbutton" class="circle">+</button>
			</div>
		</main>

		<script>
var list = new LocalTodoFile("todo")
list.pull()
updateDownload()
list.keys().forEach(function(id) {
	updateTaskElement(id)
})

function updateDownload() {
	document.getElementById("download").href = "data:text/plain," + encodeURI(list.toString())
}

function createTextElement(text) {
	var out = document.createElement("span")
	out.classList.add("task-text")
	out.innerHTML = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").
		replace(/\(([A-Z])\)/g, '<span class="task-priority task-priority-$1">(<span class="task-priority-actual">$1</span>)</span>').
		replace(/(\+[\w\d]+)/g, '<a href="?$1" class="task-project">$1</a>').
		replace(/(\@[\w\d]+)/g, '<a href="?$1" class="task-context">$1</a>').
		replace(/(due\:\d{4}-\d{2}-\d{2})/g, '<a href="?$1" class="task-due">$1</a>').
		replace(/([\w\d]+:[\w\d\-]+(?!\w|\d|\-|<|\"))/g, '<a href="?$1" class="task-metadata">$1</a>')
	return out

}

/* Creates a new task element and returns it, or returns an existing one */
function updateTaskElement(id) {
	var out = document.getElementById("task-" + id)
	if (out !== null && !list.has(id)) {
		out.remove()
		return null
	} else if (out !== null) {
		return out
	} else if (!list.has(id)) {
		return null
	}

	out = document.createElement("div")
	out.classList.add("task")
	out.id = "task-" + id

	out.appendChild(createTextElement(list.get(id)))

	out.onclick = out.onfocus = function() {
		if (out.getElementsByTagName("input").length !== 0) {
			return
		}

		out.innerHTML = ""
		
		var input = document.createElement("input")
		input.value = list.get(id)

		input.onblur = function() {
			if (input.value.length === 0) {
				list.delete(id)
				list.push()
				out.remove()
				return
			} else {
				list.set(id, input.value)
				list.push()
			}
			
			out.innerHTML = ""
			out.appendChild(createTextElement(list.get(id)))
		}

		// If backspace, delete
		input.onkeypress = function(e) {
			if ((e.keyCode === 8 || e.which === 8) && input.value === "") {
				list.delete(id)
				list.push()
				prev = out.previousSibling
				out.remove()
				if (prev.onfocus != null)
					prev.onfocus()
			}	
		}
		
		out.appendChild(input)
		input.focus()
	}

	document.getElementById("tasks").appendChild(out)
	return out
}

document.getElementById("addbutton").onclick = function() {
	var text = document.getElementById("addtext")

	var id = list.add(text.value)
	updateTaskElement(id)
	list.push()
	updateDownload()
	
	text.value = ""
}

document.getElementById("addtext").onkeypress = function(e) {
	if (e.which === 13 || e.keyCode === 13) {
		document.getElementById("addbutton").click()
	}
}
	</script>
	</body>
</html>
